# Docker User Namespace Remapping

## Configure user-namespace remapping.

From the command line:
```bash
sudo systemctl stop docker.service
```

Specify subuid and subgid

Edit /etc/subuid
```bash
sudo nano /etc/subuid

developer:1001:1
developer:100000:65535
```

Get the docker group id:
```
getent group docker
docker:x:982:developer
```

Use the obtained gid `982` to set the subgid, for specifying the docker group
for setting the user group, for usernamespace remapping. This will allow files
created on the host to belong to $USER:docker.

Edit /etc/subgid
```bash
sudo nano /etc/subgid

developer:982:1
developer:100000:65535
```

Edit /etc/docker/daemon.json
```bash
sudo nano /etc/docker/daemon.json

{
    "dns": ["8.8.8.8", "8.8.4.4"],
    "userns-remap": "developer",
    "default-runtime": "nvidia",
    "runtimes": {
        "nvidia": {
            "path": "/usr/bin/nvidia-container-runtime",
            "runtimeArgs": []
        }
    }

}
```


List available kernels:
```

```

Change default kernel:
```bash
sudo grub2-set-default 0
```


Add the `namespace.unpriv_enable=1` option to the kernel (vmlinuz*) command line. To do this, use the grubby command as follows:
```bash
sudo -s
grubby --args="namespace.unpriv_enable=1 user_namespace.enable=1" --update-kernel="$(grubby --default-kernel)"
```

List all the kernel entries and verify the changes:
```bash
# grubby --info=ALL
```

Add a value to the user.max_user_namespaces kernel tuneable so it is set permanently as follows:
```bash
echo "user.max_user_namespaces=15076" >> /etc/sysctl.conf
```

Reboot the system. After the system comes up, check that the kernel options were properly assigned and that the docker service is running with user namespaces enabled.

Reload the docker service in systemd to activate changes to the service configuration:
```bash
sudo systemctl daemon-reload
```

If you need to restart the docker service itself, enter the following command:

```bash
sudo systemctl restart docker
```
or
```bash
sudo dockerd --userns-remap="developer:developer"
```
if you didn't make an entry in daemon.json

The Docker Engine applies the same user namespace remapping rules to all containers, regardless of who runs a container or who executes a command within a container.

## Calculating the UID remapping

### root user

A `root` user will have `UID=0` inside a container.

The root user will get remapped to `developer:1001` for the following `UID` mapping values in `/etc/subuid`:

```bash
developer:1001:1
developer:100000:65535
```

### non-root user

If you have a user `developer` with `UID=1000` in a container.

The other non-root user, e.g. `developer:1000` will get remapped to `100000 + (1000-1)= 100999` on the host, for the following `UID` mapping values in `/etc/subuid`:

```bash
developer:1001:1
developer:100000:65535
```

An alternative way to specify the `/etc/subuid` configuration file:
```
developer:100000:999
developer:1001:1
developer:101000:65535
```

### Enable volume sharing

Define an additional group on the host and add the current user to the group
to be able to share data generated by a non-root user within the docker container.

```bash
sudo groupadd -g 100999 docker-developer
sudo usermod -aG docker-developer developer
```

Restart the docker daemon and service:
```bash
sudo systemctl stop docker.service;
sudo systemctl daemon-reload; sudo systemctl restart docker;
```

Make common folders shareable:

```bash
mkdir -p ~/mount/backup ~/mount/data ~/mount/project
sudo chown -R 100999:docker-developer ~/mount
sudo chmod -R g+w ~/mount
```

If the docker user `developer` has `uid=1000` and `gid=1000`,
it will be user_namespace remapped to `uid=100999` and `gid=100999`.


## Related Topics

01. [Docker and --userns-remap, how to manage volume permissions to share data between host and container?](https://stackoverflow.com/questions/35291520/docker-and-userns-remap-how-to-manage-volume-permissions-to-share-data-betwee)

## Related Links

01. [Use Linux user namespaces to fix permissions in docker volumes - Jujens' blog](https://www.jujens.eu/posts/en/2017/Jul/02/docker-userns-remap/)

02. [](https://kinvolk.io/blog/2018/04/towards-unprivileged-container-builds/)
